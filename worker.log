
> everling@1.0.0 worker:email
> tsx scripts/email-worker.ts

[Worker] Email worker started
[yuggaofeykmg10z6z4] Worker: processing inbound email job <delegawwwwtqwwe91d7@gmail.com>
Processing inbound email: {
  To: 'martinodev@everling.io',
  OriginalRecipient: undefined,
  From: 'martino.fabbro@gmail.com',
  Subject: 'Fwd: AttivitÃ  da wqedwelegare al team',
  traceId: 'yuggaofeykmg10z6z4'
}
Found recipient in To field: martinodev@everling.io
Extracted email details: {
  originalRecipient: 'martinodev@everling.io',
  toEmail: 'martinodev@everling.io',
  emailPrefix: 'martinodev',
  senderEmail: 'martino.fabbro@gmail.com',
  traceId: 'yuggaofeykmg10z6z4'
}
ğŸ“§ Sender authorization check: {
  senderEmail: 'martino.fabbro@gmail.com',
  isInAllowedList: true,
  isOrganizationMember: true,
  isAllowed: true,
  allowedEmailsCount: 1,
  allowedEmails: [ 'martino.fabbro@gmail.com' ],
  organizationMembers: [ 'martino.fabbro@gmail.com' ],
  traceId: 'yuggaofeykmg10z6z4'
}
ğŸ“§ Step 1: Checking for existing thread...
ğŸ“§ Step 2: Authorization passed (sender is allowed or replying to existing thread), proceeding to task processing...
ğŸ“§ Step 3: Looking for existing tasks in thread...
ğŸ“§ Step 3a: Reply detection check: { inReplyTo: null, hasInReplyTo: false, isForward: true }
ğŸ“§ DEBUG: Checking for duplicate with MessageID: <delegawwwwtqwwe91d7@gmail.com>
ğŸ“§ DEBUG: Organization ID: cmfmdorqu000ftqpsmyvuiv25
ğŸ“§ DEBUG: Found email logs with this MessageID: 1 [
  {
    id: 'cmg10zcex000110asy0ngd4nx',
    taskId: null,
    createdAt: 2025-09-26T15:57:22.714Z,
    processed: false
  }
]
ğŸ“§ DEBUG: Duplicate check result: {
  found: false,
  taskId: undefined,
  emailLogId: undefined,
  taskTitle: undefined
}
ğŸ“§ DEBUG: Checking for similar recent tasks...
ğŸ“§ DEBUG: Subject to match: Fwd: AttivitÃ  da wqedwelegare al team
ğŸ“§ DEBUG: Sender to match: martino.fabbro@gmail.com
ğŸ“§ DEBUG: Similar task check result: {
  found: false,
  taskId: undefined,
  taskTitle: undefined,
  createdAt: undefined
}
ğŸ“§ Step 4: Getting sender history for smart analysis...
ğŸ“§ Step 5: Analyzing thread context...
ğŸ“§ Step 6: Calculating smart priority using AI...
ğŸ“§ Command extraction result: {
  hasCommand: true,
  command: 'portare cane fuori domani mattina alle 10 30 per prendere le medicine',
  bodyLength: 69,
  forwardedContentLength: 0
}
ğŸ“§ Parsing command with AI: portare cane fuori domani mattina alle 10 30 per prendere le medicine
ğŸ“§ AI command parser raw response: {
  "hasCommand": true,
  "commandType": "remind",
  "action": "Take dog out and get medicine",
  "parameters": {
    "reminderDate": "2025-09-27T10:30:00Z",
    "notes": "Take dog out in the morning and pick up medicine",
    "status": "pending"
  },
  "confidence": 0.9
}

Key parsing details:
- Language: Italian
- Command identifies a reminder ("portare" = take)
- Specific time: 10:30 AM tomorrow morning
- Calculated reminder date uses tomorrow's date at the specified time
- Added descriptive notes about taking dog out and getting medicine
- Set default status as "pending"
- High confidence due to clear, specific instructions

The ISO timestamp is calculated from the current reference date (2025-09-26) by adding one day and setting the specific time of 10:30 AM.
ğŸ“§ Parsed command JSON: {
  hasCommand: true,
  commandType: 'remind',
  action: 'Take dog out and get medicine',
  confidence: 0.9,
  originalCommand: 'portare cane fuori domani mattina alle 10 30 per prendere le medicine',
  parameters: {
    reminderDate: '2025-09-27T10:30:00Z',
    notes: 'Take dog out in the morning and pick up medicine',
    status: 'pending'
  }
}
ğŸ“§ Normalized parameters: {
  reminderDate: '2025-09-27T10:30:00Z',
  notes: 'Take dog out in the morning and pick up medicine',
  status: 'pending'
}
ğŸ“§ AI command parsing result: {
  hasCommand: true,
  commandType: 'remind',
  action: 'Take dog out and get medicine',
  confidence: 0.9,
  originalCommand: 'portare cane fuori domani mattina alle 10 30 per prendere le medicine',
  parameters: {
    reminderDate: '2025-09-27T10:30:00Z',
    notes: 'Take dog out in the morning and pick up medicine',
    status: 'pending'
  }
}
ğŸ“§ Calling AI task extraction with data: {
  from: 'martino.fabbro@gmail.com',
  subject: 'Fwd: AttivitÃ  da wqedwelegare al team',
  bodyLength: 69,
  hasThreadContext: false,
  priorityScore: 15
}
ğŸ¤– Starting AI task extraction: {
  from: 'martino.fabbro@gmail.com',
  subject: 'Fwd: AttivitÃ  da wqedwelegare al team',
  bodyLength: 69,
  hasThreadContext: false,
  priorityScore: 15
}
ğŸ¤– Calling Claude API for task extraction...
ğŸ¤– Claude API response received, processing...
ğŸ¤– Claude response text length: 575
ğŸ¤– Claude response preview: {
  "title": "Portare il cane dal veterinario per medicine",
  "description": "Accompagnare il cane per prelevare le medicine, appuntamento programmato per domani mattina alle 10:30",
  "priority": "l...
ğŸ¤– Found JSON in response, parsing...
ğŸ¤– Extracted tags: {
  when: 'Mon, Oct 27, 2025 10:30',
  where: null,
  who: null,
  what: 'appointment',
  extras: [ 'veterinarian', 'dog medication' ]
}
ğŸ¤– Extracted task data: {
  title: 'Portare il cane dal veterinario per medicine',
  priority: 'low',
  hasDueDate: true,
  hasReminderDate: true
}
ğŸ¤– Task extraction successful: Portare il cane dal veterinario per medicine
ğŸ“§ AI task extraction result: SUCCESS
ğŸ“§ Single task to process: {
  title: 'Portare il cane dal veterinario per medicine',
  priority: 15,
  hasCommand: true,
  reason: 'User forwarded this email intentionally'
}
ğŸ“§ Applying command parameters to task: {
  hasCommand: true,
  commandType: 'remind',
  parameters: {
    reminderDate: '2025-09-27T10:30:00Z',
    notes: 'Take dog out in the morning and pick up medicine',
    status: 'pending'
  },
  originalCommand: 'portare cane fuori domani mattina alle 10 30 per prendere le medicine'
}
ğŸ¤– Extracting task relationships...
ğŸ¤– DEBUG: extractTaskRelationships input: {
  from: 'martino.fabbro@gmail.com',
  to: 'martinodev@everling.io',
  subject: 'Fwd: AttivitÃ  da wqedwelegare al team',
  organizationEmail: 'martinodev@everling.io',
  forwardedContext: undefined
}
ğŸ¤– DEBUG: AI extracted relationships: {
  assignedToEmail: 'martinodev@everling.io',
  assignedByEmail: 'martino.fabbro@gmail.com',
  taskType: 'self',
  userRole: 'executor',
  stakeholders: [
    {
      name: 'Martino Fabbro',
      email: 'martino.fabbro@gmail.com',
      role: 'task originator'
    }
  ]
}
ğŸ¤– Task relationships: {
  assignedToEmail: 'martinodev@everling.io',
  assignedByEmail: 'martino.fabbro@gmail.com',
  taskType: 'self',
  userRole: 'executor',
  stakeholders: [
    {
      name: 'Martino Fabbro',
      email: 'martino.fabbro@gmail.com',
      role: 'task originator'
    }
  ]
}
ğŸ“§ Creating task with data: {
  title: 'Portare il cane dal veterinario per medicine',
  description: 'Accompagnare il cane per prelevare le medicine, appuntamento programmato per domani mattina alle 10:',
  priority: 'medium',
  dueDate: 2025-09-27T10:30:00.000Z,
  reminderDate: 2025-09-27T10:30:00.000Z,
  organizationId: 'cmfmdorqu000ftqpsmyvuiv25',
  creatorId: 'cmfmdorqu000gtqpsfzn8x536'
}
ğŸ“§ Task created successfully: {
  taskId: 'cmg10zrc1000310ash48rliq2',
  title: 'Portare il cane dal veterinario per medicine',
  dueDate: 2025-09-27T10:30:00.000Z,
  reminderDate: 2025-09-27T10:30:00.000Z
}
[Queue] Job completed: <delegawwwwtqwwe91d7@gmail.com>
[nidqabehh4dmg1119b9] Worker: processing inbound email job <delegawwwwwtqwwe91d7@gmail.com>
Processing inbound email: {
  To: 'martinodev@everling.io',
  OriginalRecipient: undefined,
  From: 'martino.fabbro@gmail.com',
  Subject: 'Fwd: AttivitÃ  da  al team',
  traceId: 'nidqabehh4dmg1119b9'
}
Found recipient in To field: martinodev@everling.io
Extracted email details: {
  originalRecipient: 'martinodev@everling.io',
  toEmail: 'martinodev@everling.io',
  emailPrefix: 'martinodev',
  senderEmail: 'martino.fabbro@gmail.com',
  traceId: 'nidqabehh4dmg1119b9'
}
ğŸ“§ Sender authorization check: {
  senderEmail: 'martino.fabbro@gmail.com',
  isInAllowedList: true,
  isOrganizationMember: true,
  isAllowed: true,
  allowedEmailsCount: 1,
  allowedEmails: [ 'martino.fabbro@gmail.com' ],
  organizationMembers: [ 'martino.fabbro@gmail.com' ],
  traceId: 'nidqabehh4dmg1119b9'
}
ğŸ“§ Step 1: Checking for existing thread...
ğŸ“§ Step 2: Authorization passed (sender is allowed or replying to existing thread), proceeding to task processing...
ğŸ“§ Step 3: Looking for existing tasks in thread...
ğŸ“§ Step 3a: Reply detection check: { inReplyTo: null, hasInReplyTo: false, isForward: true }
ğŸ“§ DEBUG: Checking for duplicate with MessageID: <delegawwwwwtqwwe91d7@gmail.com>
ğŸ“§ DEBUG: Organization ID: cmfmdorqu000ftqpsmyvuiv25
ğŸ“§ DEBUG: Found email logs with this MessageID: 1 [
  {
    id: 'cmg111cw8000b10as99mxm6bn',
    taskId: null,
    createdAt: 2025-09-26T15:58:56.649Z,
    processed: false
  }
]
ğŸ“§ DEBUG: Duplicate check result: {
  found: false,
  taskId: undefined,
  emailLogId: undefined,
  taskTitle: undefined
}
ğŸ“§ DEBUG: Checking for similar recent tasks...
ğŸ“§ DEBUG: Subject to match: Fwd: AttivitÃ  da  al team
ğŸ“§ DEBUG: Sender to match: martino.fabbro@gmail.com
ğŸ“§ DEBUG: Similar task check result: {
  found: false,
  taskId: undefined,
  taskTitle: undefined,
  createdAt: undefined
}
ğŸ“§ Step 4: Getting sender history for smart analysis...
ğŸ“§ Step 5: Analyzing thread context...
ğŸ“§ Step 6: Calculating smart priority using AI...
ğŸ“§ Command extraction result: {
  hasCommand: true,
  command: 'portare cane fuori domani mattina alle 10 30 per prendere le medicine di laura',
  bodyLength: 78,
  forwardedContentLength: 0
}
ğŸ“§ Parsing command with AI: portare cane fuori domani mattina alle 10 30 per prendere le medicine di laura
ğŸ“§ AI command parser raw response: {
    "hasCommand": true,
    "commandType": "remind",
    "action": "Take dog out and get Laura's medicine",
    "parameters": {
        "reminderDate": "2025-09-27T10:30:00Z",
        "notes": "Take dog out in the morning and pick up Laura's medicine",
        "assignTo": "Laura"
    },
    "confidence": 0.9
}

Key parsing details:
- Language: Italian
- Command interprets "domani mattina alle 10:30" as tomorrow morning at 10:30 AM
- Converts to precise ISO timestamp based on current reference date
- Extracts key task details: taking dog out and getting medicine
- Assigns to "Laura" based on context in notes
- High confidence due to clear, structured natural language command
ğŸ“§ Parsed command JSON: {
  hasCommand: true,
  commandType: 'remind',
  action: "Take dog out and get Laura's medicine",
  confidence: 0.9,
  originalCommand: 'portare cane fuori domani mattina alle 10 30 per prendere le medicine di laura',
  parameters: {
    reminderDate: '2025-09-27T10:30:00Z',
    notes: "Take dog out in the morning and pick up Laura's medicine",
    assignTo: 'Laura'
  }
}
ğŸ“§ Normalized parameters: {
  reminderDate: '2025-09-27T10:30:00Z',
  notes: "Take dog out in the morning and pick up Laura's medicine",
  assignTo: 'Laura'
}
ğŸ“§ AI command parsing result: {
  hasCommand: true,
  commandType: 'remind',
  action: "Take dog out and get Laura's medicine",
  confidence: 0.9,
  originalCommand: 'portare cane fuori domani mattina alle 10 30 per prendere le medicine di laura',
  parameters: {
    reminderDate: '2025-09-27T10:30:00Z',
    notes: "Take dog out in the morning and pick up Laura's medicine",
    assignTo: 'Laura'
  }
}
ğŸ“§ Calling AI task extraction with data: {
  from: 'martino.fabbro@gmail.com',
  subject: 'Fwd: AttivitÃ  da  al team',
  bodyLength: 78,
  hasThreadContext: false,
  priorityScore: 15
}
ğŸ¤– Starting AI task extraction: {
  from: 'martino.fabbro@gmail.com',
  subject: 'Fwd: AttivitÃ  da  al team',
  bodyLength: 78,
  hasThreadContext: false,
  priorityScore: 15
}
ğŸ¤– Calling Claude API for task extraction...
ğŸ¤– Claude API response received, processing...
ğŸ¤– Claude response text length: 547
ğŸ¤– Claude response preview: {
  "title": "Portare il cane fuori per medicine di Laura",
  "description": "Uscita mattutina con il cane per ritirare le medicine di Laura alle 10:30",
  "priority": "low",
  "dueDate": "2025-10-27T...
ğŸ¤– Found JSON in response, parsing...
ğŸ¤– Extracted tags: {
  when: 'Mon, Oct 27, 2025 10:30',
  where: null,
  who: 'Laura',
  what: 'errand',
  extras: [ 'dog care', 'medicine pickup' ]
}
ğŸ¤– Extracted task data: {
  title: 'Portare il cane fuori per medicine di Laura',
  priority: 'low',
  hasDueDate: true,
  hasReminderDate: true
}
ğŸ¤– Task extraction successful: Portare il cane fuori per medicine di Laura
ğŸ“§ AI task extraction result: SUCCESS
ğŸ“§ Single task to process: {
  title: 'Portare il cane fuori per medicine di Laura',
  priority: 15,
  hasCommand: true,
  reason: 'User forwarded this email intentionally'
}
ğŸ“§ Applying command parameters to task: {
  hasCommand: true,
  commandType: 'remind',
  parameters: {
    reminderDate: '2025-09-27T10:30:00Z',
    notes: "Take dog out in the morning and pick up Laura's medicine",
    assignTo: 'Laura'
  },
  originalCommand: 'portare cane fuori domani mattina alle 10 30 per prendere le medicine di laura'
}
ğŸ¤– Extracting task relationships...
ğŸ¤– DEBUG: extractTaskRelationships input: {
  from: 'martino.fabbro@gmail.com',
  to: 'martinodev@everling.io',
  subject: 'Fwd: AttivitÃ  da  al team',
  organizationEmail: 'martinodev@everling.io',
  forwardedContext: undefined
}
ğŸ¤– DEBUG: AI extracted relationships: {
  assignedToEmail: 'martinodev@everling.io',
  assignedByEmail: null,
  taskType: 'self',
  userRole: 'executor',
  stakeholders: [
    { name: 'Laura', email: null, role: 'task subject (dog owner)' },
    {
      name: 'Martino Fabbro',
      email: 'martino.fabbro@gmail.com',
      role: 'task originator'
    }
  ]
}
ğŸ¤– Task relationships: {
  assignedToEmail: 'martinodev@everling.io',
  assignedByEmail: null,
  taskType: 'self',
  userRole: 'executor',
  stakeholders: [
    { name: 'Laura', email: null, role: 'task subject (dog owner)' },
    {
      name: 'Martino Fabbro',
      email: 'martino.fabbro@gmail.com',
      role: 'task originator'
    }
  ]
}
ğŸ“§ Creating task with data: {
  title: 'Portare il cane fuori per medicine di Laura',
  description: 'Uscita mattutina con il cane per ritirare le medicine di Laura alle 10:30\n' +
    '\n' +
    'ğŸ“ Note: Take dog out in ',
  priority: 'medium',
  dueDate: 2025-09-27T10:30:00.000Z,
  reminderDate: 2025-09-27T10:30:00.000Z,
  organizationId: 'cmfmdorqu000ftqpsmyvuiv25',
  creatorId: 'cmfmdorqu000gtqpsfzn8x536'
}
ğŸ“§ Task created successfully: {
  taskId: 'cmg111pr3000d10asw2pkzkjb',
  title: 'Portare il cane fuori per medicine di Laura',
  dueDate: 2025-09-27T10:30:00.000Z,
  reminderDate: 2025-09-27T10:30:00.000Z
}
[Queue] Job completed: <delegawwwwwtqwwe91d7@gmail.com>
[Queue] Job completed: <delegawwwwwtqwwe9w1d7@gmail.com>
